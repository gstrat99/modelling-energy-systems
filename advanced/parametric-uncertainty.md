# Dealing with parametric uncertainty: stochastic programming

(content:uncert-stochastic:introduction)=

## Introduction: renewable energy variability and forecasting
There are many sources of uncertainty in modelling. Uncertainty can be due to measurement errors (e.g. measurements of experiments or weather), prediction or estimation errors (e.g. predictions of future energy demand or prices), implementation errors, or inexact data (e.g. poor quality data). Renewable generation variability due to weather makes dealing with uncertainty in energy system optimisation important.

Uncertainty can be classified into two types (recall the discussion of uncertainty in {numref}`content:sensitivity-analysis`): structural uncertainty and parametric uncertainty. **Structural uncertainty** pertains to uncertainty in the model. In this case, we are unsure if the model is an accurate representation of reality. For example, it could be oversimplified, or it could fail to capture a certain factor realistically. **Parametric uncertainty** stems from limited information over the parameters in the model. Ignoring the appropriateness of the model, we do not know the exact value of certain parameters, such as energy demand or wind speed. We will focus on parametric uncertainty in this chapter.

```{figure} ../images/uncertainty-types.jpg
:name: fig:uncertainty_summary
:figwidth: 550px

Parametric uncertainty in the context of broader uncertainty. Based on a talk by David Spiegelhalter, "Uncertainty in Decision Models" (not available online).
```

When it comes to integrating renewable energy sources into energy systems, uncertainty arises due to the uncontrollability of many renewable sources. For example, the energy generated by a wind farm depends on the wind condition, which is a highly variable and uncertain parameter. On the other hand, conventional power plants can be entirely controlled by human operators, resulting in no uncertainty in energy production. Additionally, there is uncertainty in the power demand, which also depends on weather conditions, amongst other things. Unplanned outages of generators also cause uncertainty. Planning, operational, and market decisions all need to account for uncertainty.

Forecasts of weather and energy demand can help grid operators, renewable power plant operators, and energy traders make decisions. When forecasting the future, we can take several approaches ({numref}`fig:forecasting`). A point forecast uses past and present data to make one prediction of the future. It makes a conditional expectation of what may happen at a future time $t+k$ given our knowledge up to time $t$. It also does not communicate uncertainty because it gives a single forecast. A probabilistic forecast makes a range of predictions with a probability of each future outcome. The result is a probability density function for time $t+k$. Scenarios outline several possible discrete forecasts of the future. Each scenario is one realisation of a stochastic process. One possible approach is to analyse past forecast errors in order to generate possible future scenarios.

```{figure} ../images/forecasting_methods.png
:name: fig:forecasting

Different approaches to forecasting the future.
```

An everyday example is forecasting the weather. We take some initial state of the weather, which has some uncertainty around it, shown by the circle on the left side of {numref}`fig:weather_forecasting`. A model generates possible pathways of weather development over time. The outcome depends on the initial condition. Therefore, there is uncertainty in the final weather forecast. The further out we try to forecast the weather, the lower the predictability becomes.

```{figure} ../images/weather_forecast_uncertainty.png
:name: fig:weather_forecasting

Example of weather forecasting {cite:p}`bauer2015quiet`.
```

## Optimisation problem with parametric uncertainty
The optimisation problem we aim to solve is as follows:
```{math}
:label: eqn:optimisation
\begin{align}
    \begin{split}
        \min_{\mathbf{x}}&~f(\mathbf{x}, \mathbf{z}) \\
        \text{s.t.}&~\mathbf{x} \in \mathcal{X}(\mathbf{z}) \\
    \end{split}
\end{align}
```

where $\mathbf{z}$ are the uncertain input parameters. $f(\mathbf{x},\mathbf{z})$ is the objective function with decision variables $\mathbf{x}$ which belong to the feasible region $\mathcal{X}(\mathbf{z})$ (constraints). In contrast to previously-studied optimisation problems, now the objective function is a function of the uncertain parameters $\mathbf{z}$ and the decision variables must belong to a feasible region that also depends on $\mathbf{z}$.

(content:uncert-stochastic:gen-exp-example)=
### Example: generation expansion planning
```{figure} ../images/gep_toyproblem_wCon_wObj.jpg
:name: fig:gen_exp
:figwidth: 600 px

Generation expansion planning problem with three generators A, B, and C that collectively meet demand given generation limits. The goal is to decide how much investment to make in the capacity of each generator while minimising cost.
```
Let's consider the example of generation expansion planning. Energy is produced by three generators: A, B, and C. The objective is to minimise total costs, which include fixed and variable costs of each generator. The decision variables $x_g$ represent the installed capacity of each generator (i.e. the investment made in each generation type). The decision variables $y_g$ represent the actual energy generation of each generator and must be greater than or equal to zero. There are a number of uncertain parameters in this problem: demand $d$, capacity factors $\tau_g$, fixed costs $f_g$, and variable costs $c_g$. The cost associated with running a generator is the fixed cost multiplied by the capacity investment plus the variable cost multiplied by the actual energy generation. This leads to the optimisation problem:
```{math}
\begin{align}
    \min&~\sum_{g} f_g x_g + \sum_{g} c_g y_g \\
    \text{s.t.}&~\sum_{g} y_g \geq d \\
    &~y_g \leq \tau_g x_g, &\forall g \in  \{A, B, C\}  \\
    &~y_g \geq 0, &\forall g \in  \{A, B, C\} \\
    &~x_g \in \{0,1,2,3\}, &\forall g \in  \{A, B, C\}
\end{align}
```

In this case, $\mathbf{x} = (x_A, x_B, x_C, y_A, y_B, y_C)$ so there are six decision variables; and $\mathbf{z} = (d, \tau_A, \tau_B, \tau_C, f_A, f_B, f_C, c_A, c_B, c_C)$ are the ten uncertain parameters. The first constraint is the demand constraint. The second and third constraints are the generation limits. The last constraint represents the level of investment in each generator.

(content:uncert-stochastic:stochastic-programming)=
## Stochastic programming
One way of dealing with uncertainty in optimisation problems is **stochastic programming**. The key assumption in stochastic programming is that the probability distribution for the uncertain parameters can be estimated. We can simplify a stochastic model into a deterministic model by assuming that the uncertain parameters are certain (i.e. by replacing uncertain parameters with their expected values). We can also use stochastic programming to formulate a problem with "recourse", meaning we can delay decisions until we know more about as-yet uncertain parameters.

### Stochastic programming formulation
Consider the optimisation problem:
\begin{align}
    \begin{split}
        \min_{\mathbf{x}}&~f(\mathbf{x}, \mathbf{z}) \\
        \text{s.t.}&~g(\mathbf{x}, \mathbf{z}) \leq 0 \\
    \end{split}
\end{align}
again with decision variables $\mathbf{x}$ and uncertain parameters $\mathbf{z}$. We assume that $\mathbf{z}$ is a realisation of random variables $\tilde{\mathbf{z}}$ with known probability distribution $\mathbb{P}$. We call this a **stochastic process**, which is a probability distribution over a set of paths describing the expected evolution of a random or uncertain variable. The variables can be discrete (e.g. policy decisions) or continuous (e.g. natural gas prices).

```{figure} ../images/probability_distributions.png
:name: fig:probability_distributions
:figwidth: 400px

Discrete vs. continuous probability distributions $\mathbb{P}$ of $\tilde{\mathbf{z}}$
```

Given knowledge of the probability distribution $\mathbb{P}$ of $\tilde{\mathbf{z}}$, we can reformulate the optimisation problem as a stochastic problem:
```{math}
:label: eqn:stochastic
\begin{align}
    \begin{split}
        \min_{\mathbf{x}}&~\mathbb{E}_{\mathbb{P}} \left[ f(\mathbf{x}, \tilde{\mathbf{z}}) \right] \\
        \text{s.t.}&~\mathbb{P} \left( g(\mathbf{x}, \tilde{\mathbf{z}}) \leq 0 \right) \geq 1-\epsilon \\
    \end{split}
\end{align}
```
$\mathbb{E}_{\mathbb{P}} \left[ f(\mathbf{x}, \tilde{\mathbf{z}}) \right]$ is the expected value of $f(\mathbf{x}, \tilde{\mathbf{z}})$, which is what we want to optimise now. The probability of constraint violation must be less than $\epsilon$. In Equation {eq}`eqn:stochastic`, this is written as the probability that the original constraint given $\tilde{\mathbf{z}}$ is true/satisfied must be greater than or equal to $1-\epsilon$. In other words, we want the solution to be feasible $1-\epsilon$ of the time, so the constraint must hold for a certain $(1-\epsilon)\%$ of $\tilde{\mathbf{z}}$. The value of $\epsilon$ is set by the modeler, depending on how much risk is acceptable.

#### Discrete probability distribution
Now that we have written the stochastic problem, we will move on to how to solve it. If the probability distribution $\mathbb{P}$ is discrete then the problem can be made deterministic. In this case, $\mathbb{P}$ consists of $N$ discrete scenarios $\mathbf{z}^1, \dotsc, \mathbf{z}^N$ that occur with known probabilities $p^1, \dotsc, p^N$. Then we rewrite the problem in Equation {eq}`eqn:stochastic` as:
```{math}
:label: eqn:stochastic_discrete
\begin{align}
    \begin{split}
        \min_{\mathbf{x}, \mathbf{b}}&~\sum\limits_{i=1}^N p^i f(\mathbf{x}, \mathbf{z}^i) \\
        \text{s.t.}&~g(\mathbf{x}, \mathbf{z}^i) \leq b^i M,~~i=1,\dotsc,N \\
        &~\sum\limits_{i=1}^N p^i b^i \leq \epsilon \\
    \end{split}
\end{align}
```
We introduce the binary variables $b^i \in \{0,1\}, i=1,\dotsc,N$. If $b^i$ is 0 then the constraint is not violated and if $b^i$ is 1 then the constraint is violated. The bottom line in Equation {eq}`eqn:stochastic_discrete` allows a limited number of constraints to be violated. $M$ is a sufficiently large constant. This deterministic problem can only be solved if the number of scenarios $N$ is not too large.

#### Continuous probability distribution
If the probability distribution $\mathbb{P}$ is continuous then there are only tractable reformulations for specific situations. For example, when $\tilde{\mathbf{z}}$ are uniformly distributed (a simple, well-known distribution) and $f$ and $g$ are linear functions. Because the distribution is continuous, there are an infinite number of possible scenarios and they are impossible to enumerate. Often, we have to use sampling-based approximations {cite:p}`homem2014monte`. Instead of dealing with probability distribution $\mathbb{P}$ in a direct manner, we sample $N$ scenarios $\mathbf{z}^1, \dotsc, \mathbf{z}^N$ from $\mathbb{P}$ and approximate the stochastic programming problem in Equation {eq}`eqn:stochastic`.

### Limitations of stochastic programming
Aside from the challenges associated with a continuous distribution, there are a number of other limitations of stochastic programming. In reality, the probability distribution $\mathbb{P}$ is often unknown. We do not actually know the probability with which the uncertain parameters $\mathbf{z}$ take on particular values. Even if $\mathbb{P}$ is known, solving stochastic programming exactly is only possible in specific cases. We mentioned a discrete distribution with a small number of scenarios or a continuous uniform distribution with linear functions. Otherwise, we have to rely on sampling-based approximations to solve stochastic programming problems. Lastly, as the number of uncertain parameters increases, the computational tractability of the problem quickly deteriorates. We want to realistically represent the uncertainty in a problem, but it still has to be solvable with a computer.

### Stochastic programming example: demand response
In this example, we want to adjust demand to better match the fluctuating supply of renewable energy sources. A consumer performs a certain task that requires the use of electricity. The utility function $f_t(u_t)$ measures the benefit of consuming energy $u_t$ for the task during time period $t = 1, ..., T$.

#### {{ labeled_circle_params }}
Consider four time periods ($T = 4$).

We know that the total consumption for the four time periods together must be between 6 and 8 kWh.

We also know the consumption cannot be higher than $U_{max}$ = 3 kWh for each time period $t$.

We also know the ramping limit (up or down) is $U_{ramp}$ = 1.5 kWh between any two time periods.

Now we introduce uncertainty with a stochastic process. Electricity price per time period is an uncertain parameter. We consider price uncertainty with scenarios, indexed by $\omega$. $\lambda$ is the set of possible realisations of the stochastic process, or prices. $\lambda_\omega$ is a vector representing one possible realisation of the stochastic process. (Note that in this example, stochastic process = uncertain model parameter = price uncertainty.) Each realisation $\lambda_\omega$ is associated with a probability $\pi_\omega$. In this example, we consider a discrete probability distribution consisting of two scenarios so the probabilities $\pi_1$ and $\pi_2$ add up to 1. The table below shows the scenarios we consider.

| Scenario | Probability | Price | Price | Price | Price |
| --- | --- | --- | --- | --- | --- |
| $\omega$ | $\pi_\omega$ | $\lambda_1$| $\lambda_{2\omega}$ | $\lambda_{3\omega}$ | $\lambda_{4\omega}$ |
| 1 | 0.5 | 120 | 105 | 154 | 84 |
| 2 | 0.5 | 120 | 45 | 66 | 36 |

So, we have two scenarios with 50\% probability each. Note that $\lambda_1 = 120$ in both scenarios.

#### {{ labeled_circle_vars }}
We want to decide how much energy to consume $u_{t\omega}$ during time period $t = 1, ..., T$. Because we have two scenarios, and one certain time period, there are seven optimisation variables: $u_1, u_{21}, u_{31}, u_{41}, u_{22}, u_{32}, u_{42}$ (the consumption at $t=1$ and the scenario-dependent consumption at $t=2,3,4$).

#### {{ labeled_circle_obj }}
Our objective is to maximise welfare (minimise costs minus benefits):

\begin{align}
    \min \left[ \lambda_1 u_1 - f_1(u_1) + \sum_{\omega=1}^\Omega \pi_\omega \times \sum_{t=2}^T (\lambda_{t\omega} u_{t\omega} - f_t(u_{t\omega}) ) \right]
\end{align}

This is the implementation of the objective function in Equation {eq}`eqn:stochastic_discrete`. The first part with $t=1$ represents the certain part because $\lambda_1 = 120$ always. The utility function $f_t(u_t)$ is a linear function of consumption $u_t$: $f_t(u_t) = 100 u_t$.

#### {{ labeled_circle_constr }}
We have three practical constraints to consider.

First, the consumption per time period cannot be higher than $U_{max}$ = 3 kWh:

\begin{equation}
    U_{min} \leq u_t \leq U_{max}
\end{equation}

Second, the total consumption for the four periods together must be between 6 and 8 kWh.

Third, there is a ramping limit of 1.5 kWh between time periods.

#### Full problem
In our example, we end up with the following optimisation problem:

* Variables: $u_1, u_{21}, u_{31}, u_{41}, u_{22}, u_{32}, u_{42}$
* Objective (to be minimised):
\begin{equation}
    \begin{split}
        J = &  (120-100)u_1 + 0.5\left[(105-100)u_{21} + (154-100)u_{31} + (84-100)u_{41}\right] \\
        & + 0.5\left[(45-100)u_{22} + (66-100)u_{32} + (36-100)u_{42}\right]
    \end{split}
\end{equation}
* Consumption per time period constraint:
\begin{equation}
    \begin{split}
        0 \leq u_1 \leq 3 & \\
        0 \leq u_{t\omega} \leq 3 & \hspace{20 pt} \omega=1,2, t=2,3,4 \\
    \end{split}
\end{equation}
* Total consumption constraint:
\begin{equation}
    \begin{split}
        u_1 + \sum_t u_{t\omega} \leq 8 & \hspace{20 pt} \omega=1,2, t=2,3,4 \\
        u_1 + \sum_t u_{t\omega} \geq 6 & \hspace{20 pt} \omega=1,2, t=2,3,4 \\
    \end{split}
\end{equation}
* Ramping limits constraint:
\begin{equation}
    \begin{split}
        u_1 - u_0 \leq 1.5 & \hspace{20 pt} \omega=1,2, u_0=0 \\
        u_{2\omega} - u_1 \leq 1.5 & \hspace{20 pt} \omega=1,2 \\
        u_{t\omega} - u_{(t-1)\omega} \leq 1.5 & \hspace{20 pt} \omega=1,2, t=3,4 \\
        u_0 - u_1 \leq 1.5 & \hspace{20 pt} \omega=1,2, u_0=0 \\
        u_1 - u_{2\omega} \leq 1.5 & \hspace{20 pt} \omega=1,2 \\
        u_{(t-1)\omega} - u_{t\omega} \leq 1.5 & \hspace{20 pt} \omega=1,2, t=3,4 \\
    \end{split}
\end{equation}

#### Optimal solution
The optimal solution of our example is:
| Scenario | $u_1$ | $u_{2\omega}$ | $u_{3\omega}$ | $u_{4\omega}$ | Total |
| --- | --- | --- | --- | --- | --- |
| 1 | 0.25 | 1.75 | 1.25 | 2.75 | 6 |
| 2 | 0.25 | 1.75 | 3 | 3 | 8 |

```{figure} ../images/stochastic_programming_ex_soln.png
:name: fig:stochastic_programming_ex_soln
:figwidth: 450px

Optimal solution of energy consumption during each time period
```

We can think of our example as a two-stage stochastic programming problem. In the first stage (here and now), decisions $u$, not depending on the realisation of the uncertain parameters, are made. The parameters (price) in the first time period are certain so we can decide how much energy to consume now. Then, the outcome $\lambda_\omega$ of the random parameter vector $\lambda$ is realised. In the second stage (wait and see), the decisions $u_\omega$ are made according to $\lambda_\omega$. As the price in each time period is revealed, we adapt and decide how much energy to consume. This two-stage approach allows the decision-maker to adapt to the actual outcome of random events while still achieving the overall optimal outcome given the uncertainty.



## References

```{bibliography}
:filter: docname in docnames
```
